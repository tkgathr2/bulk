# 仕様書：一括検索君（Plan）V1.2（最終100点・第2回改善）

## 現在のフェーズ / 進捗

- フェーズ：Plan（仕様書）
- 進捗：40%（Plan最終案を作成し、最終承認待ちの段階のため）

---

## 0. 本仕様書の位置づけ

- 本書 `docs/plan.md` を **唯一の仕様書** とする
- Ask（要件定義）の最終版：`docs/ask/V1.2.md`
- 画面遷移図：`docs/screen_flow.md`
- 画面モック：`mockups/`（合意形成用。実装は本仕様書に従う）

---

## 1. 前提条件

- 会社で以下を利用していること
  - Google Workspace（Gmail / Google ドライブ）
  - Slack
  - Dropbox（Business想定）
- 利用端末：PCブラウザ（Chrome / Edge）
- MVPではモバイル最適化は行わない

---

## 1.1 ローカル開発URL（ポート）憲法への対応（未決定）

実装開始前にローカル開発用URL（ポート）を決める必要がある。

- 3000番ポートは原則使用しない
- **Plan確定後（Impl開始前）に、他プロジェクトと衝突しない根拠とともに決定する**

本仕様書では以下の選択肢を提示し、Impl開始前に確定する（推測で決めない）。

- A案：5173（Vite系で一般的、3000回避）【おすすめ】
- B案：3100
- C案：8080

### 決定手順（Windows / PowerShell）

Impl開始前に、候補ポートが空いていることを確認して決める。

- 確認コマンド例：
  - `netstat -ano | findstr :5173`
  - `netstat -ano | findstr :3100`
  - `netstat -ano | findstr :8080`
- 結果が0行なら未使用と判断し、そのポートを採用する
- 5173が使用中なら 3100、3100も使用中なら 8080 を試す
- いずれも使用中なら、追加候補を提示して再決定する

---

## 1.2 デプロイ先（未確定・Planの範囲）

MVPでは「会社内の誰でもブラウザからアクセス可能」を満たす必要がある。

- 本仕様書ではクラウド前提とし、具体サービス（例：GCP/AWS/Azure等）は **Impl開始前に確定**する
- ただし、セキュリティ要件（SSO/ネットワーク制限/監査）によりオンプレが必要な場合は、ここで分岐して要件化する

---

## 2. ゴール / 非ゴール

### 2-1. ゴール（MVP）

- 1つの検索窓で Slack / Gmail / Dropbox / Google ドライブ を横断検索できる
- 検索結果を統一UIで閲覧し、サイドプレビューで概要を確認できる
- 「元サービスで開く」から一次情報に遷移できる

### 2-2. 非ゴール（MVP）

- 編集・削除・移動などのデータ操作
- Slack DM / プライベートチャンネル検索
- Googleスプレッドシートのセル内容検索

---

## 3. 用語定義

- **コネクタ**：各サービス（Slack/Gmail/Dropbox/Drive）と連携し検索する処理単位
- **検索ジョブ**：検索キーワード＋フィルタ条件で実行される1回の検索処理
- **検索結果アイテム**：各サービスから返る1件の結果（メッセージ/メール/ファイル等）

---

## 4. ユースケース（MVP）

1. ユーザーがログインする（Google）
2. ユーザーが検索キーワードを入力し、必要ならフィルタを設定して検索する
3. 結果をサービス別タブで切り替え、必要ならソート変更する
4. 結果をクリックしてサイドプレビュー/詳細を確認する
5. 元サービスで開いて最終確認する
6. 必要に応じてサービス連携（接続/切断）を行う

---

## 4.1 ユースケース別の期待結果（DoDの種）

- 検索が成功したサービスは結果が表示され、失敗したサービスは「失敗理由＋再試行」が表示される
- 検索結果0件のサービスは「0件」と明示される（失敗と混同しない）
- 「元サービスで開く」は別タブで開く（ユーザーが戻れる）

---

## 5. 機能仕様（MVP）

### 5-1. 検索入力

- キーワード（必須）
- フィルタ（任意）
  - サービス絞り込み（デフォルト全選択）
  - 日付範囲（開始日・終了日）
  - ファイル種別（ドキュメント/スプレッドシート/PDF/画像/その他）

### 5-2. 検索実行

- 各コネクタへ **並列** にリクエストする
- 1コネクタが失敗しても、他コネクタは継続する
- タイムアウト：MVPでは「初回表示を優先」し、遅いサービスは後から到着して追記表示する

#### 検索の状態モデル（UI/API共通）

検索ジョブに対し、サービスごとに以下の状態を持つ。

- `success`：結果取得に成功（0件を含む）
- `error`：API失敗（認証/権限/レート/ネットワーク等）
- `partial`：一部のみ取得（ページング途中等）
- `loading`：取得中（遅延中）

UIはサービス別タブに、件数（`success`のみ）または状態（`error/loading`）を表示する。

### 5-3. 結果表示

- サービス別タブで分類表示し、件数バッジを表示する
- ソート：関連度 / 新しい順 / 古い順
- ページング：「もっと見る」で追加読み込み（20件単位）
- レイアウト：左リスト＋右サイドプレビュー
- サイドプレビューは「選択中アイテムの要約（スニペット、メタ情報、アクション）」を表示する

#### タブの定義

- タブ：`すべて` / `Slack` / `Gmail` / `Dropbox` / `Google Drive`
- `すべて` は全サービスの結果を統合表示する（並び順はソートに従う）

### 5-4. 詳細表示

- メタ情報（サービス、更新日、作成者など）
- 本文プレビュー（可能な範囲）
- 「元サービスで開く」ボタン
- 本文プレビューは「保存しない」方針に従い、必要最小限の表示に留める（実装詳細はImplで確定）

#### 本文プレビューの方針（MVPでの明確化）

- 本文プレビューは「検索結果として得られた断片（snippet）」を基本とする
- ファイル本文の全量表示・ダウンロードはMVPでは行わない（元サービスで確認させる）

### 5-5. 検索履歴

- ユーザー単位で直近30件を保存
- 検索バーのフォーカス時に候補として表示
- 個別削除 / 全削除

### 5-6. サービス連携設定

- Slack / Gmail / Dropbox / Drive の接続状態を表示
- 接続 / 切断（再認証）導線

#### 接続状態の定義

- `connected`：有効なトークンがあり検索可能
- `disconnected`：未接続
- `expired`：期限切れ（再認証が必要）
 
設定画面では状態と、次アクション（接続/再接続/切断）を表示する。

---

## 6. 画面仕様（MVP）

画面一覧は Ask に準拠し、詳細はモック `mockups/` を参考にする。

### 6-1. UI方針

- デザインは **Google（Workspace系）寄せ**
- 文言・名称は **「一括検索君」** に統一

- ログイン
- 検索トップ
- 検索結果一覧
- 検索結果詳細
- サービス連携設定

---

## 7. 認証・認可 / セキュリティ

### 7-1. 原則

- 各ユーザーの OAuth 認可範囲内のデータのみ検索・閲覧できる
- 他人のデータは閲覧できない

### 7-2. トークン

- サーバー側で暗号化保存する
- ブラウザから取得できないようにする

### 7-2a. 保存場所（MVPの原則）

- アクセストークン/リフレッシュトークン等の認証情報は、フロントエンドの永続ストレージ（localStorage等）へ保存しない
- サーバー側で暗号化して保存し、フロントはセッション識別子のみを持つ（方式はImplで確定）

### 7-3. 監査・ログ（MVP最小）

- ユーザー操作ログ（誰がいつ検索したか）は **MVPでは保存しない**
- 将来的に必要になった場合は第3段階として要件化する

---

## 7.4 権限・共有ドライブの扱い（MVPの線引き）

- Google Drive の「共有ドライブ」や共有フォルダは、ユーザーがアクセス可能な範囲に限り検索対象に含める
- 組織全体を横断する管理者検索はMVPでは行わない

---

## 8. データ定義（MVP・暫定）

### 8-1. 検索条件

- `query`: string
- `services`: array（slack/gmail/dropbox/drive）
- `date_from`: date|null
- `date_to`: date|null
- `file_type`: enum|null

#### `file_type` 定義（MVP）

- `document`（文書）
- `spreadsheet`（表）
- `presentation`（スライド）
- `pdf`
- `image`
- `other`

### 8-1a. 検索レスポンス（共通）

- `job_id`: string
- `requested_at`: datetime
- `query`: string
- `filters`: object
- `services`: object（サービス別の状態と結果）

### 8-2. 検索結果アイテム（共通）

- `id`: string（サービス内ID）
- `service`: enum
- `title`: string
- `snippet`: string|null
- `updated_at`: datetime|null
- `author`: string|null
- `url`: string（元サービスURL）
- `kind`: enum（message/email/file）

### 8-3. 検索結果アイテム（サービス別の追加フィールド）

- Slack：`channel_name`（表示用、取得できる範囲）
- Gmail：`from` / `to` / `subject`
- Drive/Dropbox：`path` / `mime_type` / `file_size`

---

## 8.4 データ保持（MVP）

- 検索履歴：ユーザー単位で最大30件（本文は保存しない。クエリ文字列＋フィルタのみ）
- 接続情報：暗号化して保存（SEC-01の範囲。実値は本文書に含めない）

---

## 9. 例外ケース

- API未対応のファイル形式：ファイル名のみ検索し、本文検索非対応を表示
- レートリミット：待機の案内と再試行導線を表示
- トークン期限切れ：設定画面へ誘導して再認証

### 9.2 0件と失敗の違い（表示ルール）

- 0件：`success` かつ `total=0` として表示する（「0件」）
- 失敗：`error` として表示する（「失敗理由」「再試行」）

---

## 9.1 Slackスコープ（MVPの明確化）

- Slackは **パブリックチャンネルのみ**
- DM/プライベートは「今後対応予定」とUIに明記

---

## 10. NG例

- ユーザーAがユーザーBのデータを検索・閲覧できる
- OAuthトークンがブラウザの開発者ツール等から漏洩する
- 1サービス障害で検索全体が止まる
- サーバーがファイル本文を恒久保存する（MVPでは不可）

---

## 11. 受け入れ条件（MVP・暫定）

- Slack/Gmail/Dropbox/Drive のうち、最低1つが未接続でも検索画面は利用できる（未接続は設定へ誘導）
- 検索で、サービス別タブに結果件数が表示される
- 結果クリックでサイドプレビューが更新される
- 「元サービスで開く」で元ページへ遷移できる
- 検索履歴が最大30件保存され、削除できる

---

## 11.1 受け入れ条件（より具体）

- サービス絞り込みをOFFにしたサービスにはリクエストしない
- 1サービスが失敗しても、他サービスのタブは閲覧できる
- 失敗したサービスは「失敗」表示と「再試行」導線がある
- レートリミット時は「待機の案内」が表示される

---

## 11.2 受け入れ条件（チェックリスト形式）

- [ ] すべて/各サービス別タブで、件数・状態が一貫して表示される
- [ ] すべてタブの並び順が、選択中ソートと一致する
- [ ] 右サイドプレビューが、選択中アイテムに追従して更新される
- [ ] 本文プレビューはスニペット中心で、全文保存/ダウンロードを行わない
- [ ] Slackはパブリックのみ検索され、DM/プライベートは対象外であることがUIに明記される
- [ ] Drive/Dropboxは「本文検索できない形式」でフォールバック表示が出る

---

## 12. 完了条件（Planフェーズ）

- 本仕様書に以下が揃っている
  - 前提条件
  - 受け入れ条件
  - NG例
  - 例外ケース
  - データ定義
  - 完了条件

### Plan完了の追加条件（Impl移行ゲート）

- ローカル開発ポートが「衝突確認ログつき」で決定済み
- デプロイ先の方針（クラウド/オンプレ）が決定済み

---

## 13. SEC-01（シークレット）注意喚起

この工程ではシークレット情報が必要になる可能性があります。SEC-01 で停止します。

- OAuth のクライアント情報（Client ID / Client Secret など）は **本書には記載しない**
- 実装段階でプレースホルダ（`REPLACE_WITH_SECRET`）を用意し、ユーザーが手動投入する

### SEC-01 手順（MVP）

- 実装者は `.env` 等に `REPLACE_WITH_SECRET` を置く
- 管理画面等で取得したシークレット値の **コピー/貼り付けは人間が実施**する
- Chat / md / ログ / コミットに実値を残さない

---

## 14. Devin（本格開発）に渡す条件

Devinへ実装を渡すのは、以下が揃った時点とする。

- 本仕様書（`docs/plan.md`）が最終承認済み
- SEC-01の投入手順が合意済み（実値は書かない）
- ローカル開発ポートが衝突根拠つきで決定済み

---

## 15. 未決定事項（Impl開始前に要確定）

推測で決めないため、以下は **Impl開始前に決定**する。

- デプロイ先：クラウド/オンプレ、具体サービス
- ローカル開発ポート：5173/3100/8080のいずれか（衝突確認つき）
- 同時利用者数の上振れ（50を超える可能性があるか）

